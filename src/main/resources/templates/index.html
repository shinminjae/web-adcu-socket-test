<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WEB-ADCU WebSocket í…ŒìŠ¤íŠ¸ v5.4 - í”„ë¡œí† ì½œ í…ŒìŠ¤í„°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .connection-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }
        
        .connection-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .input-group label {
            font-weight: 600;
            color: #495057;
            min-width: 100px;
        }
        
        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(86, 171, 47, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 65, 108, 0.4);
        }
        
        .protocol-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .protocol-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s;
        }
        
        .protocol-card:hover {
            border-color: #667eea;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        
        .protocol-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .command-list {
            display: grid;
            gap: 15px;
        }
        
        .command-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
        }
        
        .command-item:hover {
            background: #e9ecef;
            border-color: #667eea;
        }
        
        .command-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .command-name {
            font-weight: 600;
            color: #2c3e50;
            flex: 1;
        }
        
        .command-description {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 10px;
        }
        
        .command-json {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            margin-bottom: 10px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .status-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        
        .status-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .status-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
        }
        
        .status-card h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.1em;
        }
        
        .status-content {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .connection-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-connected {
            background: #d4edda;
            color: #155724;
        }
        
        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .loading {
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .protocol-section {
                grid-template-columns: 1fr;
            }
            
            .status-grid {
                grid-template-columns: 1fr;
            }
            
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ¾ WEB-ADCU WebSocket í…ŒìŠ¤íŠ¸</h1>
            <p>Module-Socket ì„œë²„ì™€ì˜ í”„ë¡œí† ì½œ í…ŒìŠ¤í„° v5.4</p>
        </div>
        
        <div class="content">
            <!-- ì—°ê²° ì„¤ì • ì„¹ì…˜ -->
            <div class="connection-section">
                <h2>ğŸ”— WebSocket ì—°ê²° ì„¤ì •</h2>
                <div class="input-group">
                    <label>ì„œë²„ URL:</label>
                    <input type="text" id="serverUrl" value="ws://localhost:8908/ws" placeholder="WebSocket ì„œë²„ URL">
                </div>
                <div class="input-group">
                    <label>ë””ë°”ì´ìŠ¤ ID:</label>
                    <input type="text" id="deviceId" value="TRACTOR_001" placeholder="ë””ë°”ì´ìŠ¤ ID">
                </div>
                <div class="input-group">
                    <button class="btn btn-primary" onclick="connect('app')">ğŸ“± APP ì—°ê²°</button>
                    <button class="btn btn-primary" onclick="connect('adcu')">ğŸ¤– ADCU ì—°ê²°</button>
                    <button class="btn btn-danger" onclick="disconnectAll()">âŒ ëª¨ë“  ì—°ê²° í•´ì œ</button>
                </div>
            </div>
            
            <!-- í”„ë¡œí† ì½œ í…ŒìŠ¤íŠ¸ ì„¹ì…˜ -->
            <div class="protocol-section">
                <!-- APP ëª…ë ¹ì–´ -->
                <div class="protocol-card">
                    <h3>ğŸ“± APP ëª…ë ¹ì–´ (í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„)</h3>
                    <div class="command-list" id="appCommands">
                        <div class="loading">ëª…ë ¹ì–´ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
                
                <!-- ADCU ëª…ë ¹ì–´ -->
                <div class="protocol-card">
                    <h3>ğŸ¤– ADCU ëª…ë ¹ì–´ (ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸)</h3>
                    <div class="command-list" id="adcuCommands">
                        <div class="loading">ëª…ë ¹ì–´ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>
            
            <!-- ìƒíƒœ ëª¨ë‹ˆí„°ë§ ì„¹ì…˜ -->
            <div class="status-section">
                <h2>ğŸ“Š ì‹¤ì‹œê°„ ìƒíƒœ ëª¨ë‹ˆí„°ë§</h2>
                <div class="status-grid">
                    <div class="status-card">
                        <h4>ğŸ“± APP ì—°ê²° ìƒíƒœ</h4>
                        <div class="connection-status" id="appStatus">ì—°ê²° í•´ì œë¨</div>
                        <h4 style="margin-top: 15px;">ìµœê·¼ ìš”ì²­</h4>
                        <div class="status-content" id="appRequest">ëŒ€ê¸° ì¤‘...</div>
                        <h4 style="margin-top: 15px;">ìµœê·¼ ì‘ë‹µ</h4>
                        <div class="status-content" id="appResponse">ëŒ€ê¸° ì¤‘...</div>
                    </div>
                    
                    <div class="status-card">
                        <h4>ğŸ¤– ADCU ì—°ê²° ìƒíƒœ</h4>
                        <div class="connection-status" id="adcuStatus">ì—°ê²° í•´ì œë¨</div>
                        <h4 style="margin-top: 15px;">ìµœê·¼ ìš”ì²­</h4>
                        <div class="status-content" id="adcuRequest">ëŒ€ê¸° ì¤‘...</div>
                        <h4 style="margin-top: 15px;">ìµœê·¼ ì‘ë‹µ</h4>
                        <div class="status-content" id="adcuResponse">ëŒ€ê¸° ì¤‘...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let protocols = {};
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ í”„ë¡œí† ì½œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        async function loadProtocols() {
            try {
                console.log('í”„ë¡œí† ì½œ ë°ì´í„° ë¡œë”© ì‹œì‘...');
                const response = await fetch('/protocols');
                console.log('API ì‘ë‹µ:', response);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('ë¡œë“œëœ í”„ë¡œí† ì½œ ë°ì´í„°:', data);
                
                protocols = data;
                renderCommands();
            } catch (error) {
                console.error('í”„ë¡œí† ì½œ ë¡œë“œ ì‹¤íŒ¨:', error);
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ ë°ì´í„°ë¡œ í´ë°±
                loadFallbackProtocols();
            }
        }
        
        // í´ë°± í”„ë¡œí† ì½œ ë°ì´í„°
        function loadFallbackProtocols() {
            protocols = {
                app: [
                    { name: "ì‹œì‘", description: "ììœ¨ì£¼í–‰ ì‹œì‘", json: '{ "requestType": "app", "deviceId": "TRACTOR_001", "command": "remote_go" }' },
                    { name: "ë©ˆì¶¤", description: "ììœ¨ì£¼í–‰ ì¤‘ì§€", json: '{ "requestType": "app", "deviceId": "TRACTOR_001", "command": "remote_stop" }' },
                    { name: "í™ˆ (ë³µê·€ì£¼í–‰)", description: "í™ˆìœ¼ë¡œ ë³µê·€ì£¼í–‰", json: '{ "requestType": "app", "deviceId": "TRACTOR_001", "command": "remote_autodriving", "target": "home" }' }
                ],
                adcu: [
                    { name: "ì‹¤ì‹œê°„ ìœ„ì¹˜", description: "ì‹¤ì‹œê°„ ìœ„ì¹˜ ì •ë³´ ì „ì†¡", json: '{ "responseType": "adcu", "deviceId": "TRACTOR_001", "command": "RealtimeLocation", "log": true }' },
                    { name: "ì°¨ëŸ‰ ìƒíƒœ", description: "ì°¨ëŸ‰ ìƒíƒœ ì •ë³´ ì „ì†¡", json: '{ "responseType": "adcu", "deviceId": "TRACTOR_001", "command": "vehicle_status", "lat": "37.5665", "lon": "126.9780", "message": "ì •ìƒ ìš´í–‰ ì¤‘" }' }
                ]
            };
            renderCommands();
        }
        
        // ëª…ë ¹ì–´ ëª©ë¡ ë Œë”ë§
        function renderCommands() {
            console.log('ëª…ë ¹ì–´ ë Œë”ë§ ì‹œì‘...');
            renderCommandList('appCommands', protocols.app || []);
            renderCommandList('adcuCommands', protocols.adcu || []);
        }
        
        function renderCommandList(containerId, commands) {
            console.log(`${containerId} ë Œë”ë§:`, commands);
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (!commands || commands.length === 0) {
                container.innerHTML = '<div class="loading">ëª…ë ¹ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            commands.forEach(cmd => {
                const commandItem = document.createElement('div');
                commandItem.className = 'command-item';
                commandItem.innerHTML = `
                    <div class="command-header">
                        <span class="command-name">${cmd.name}</span>
                        <button class="btn btn-success" onclick="sendProtocol('${containerId === 'appCommands' ? 'app' : 'adcu'}', '${cmd.name}')">
                            ì „ì†¡
                        </button>
                    </div>
                    <div class="command-description">${cmd.description}</div>
                    <div class="command-json">${cmd.json}</div>
                `;
                container.appendChild(commandItem);
            });
        }
        
        // WebSocket ì—°ê²°
        async function connect(type) {
            const serverUrl = document.getElementById('serverUrl').value;
            const deviceId = document.getElementById('deviceId').value;
            
            if (!serverUrl || !deviceId) {
                alert('ì„œë²„ URLê³¼ ë””ë°”ì´ìŠ¤ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch('/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `serverUrl=${encodeURIComponent(serverUrl)}&deviceId=${encodeURIComponent(deviceId)}&deviceType=${type}`
                });
                
                // ì‹¤ì œ ì—°ê²° ìƒíƒœ í™•ì¸
                await checkConnectionStatus(type);
            } catch (error) {
                console.error('ì—°ê²° ì‹¤íŒ¨:', error);
                alert('ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì‹¤ì œ ì—°ê²° ìƒíƒœ í™•ì¸
        async function checkConnectionStatus(type) {
            try {
                console.log('=== checkConnectionStatus ì‹œì‘ ===');
                console.log('type:', type);
                
                const response = await fetch(`/connection-status?deviceType=${type}`);
                console.log('connection-status ì‘ë‹µ:', response);
                console.log('ì‘ë‹µ ìƒíƒœ:', response.status);
                
                const data = await response.json();
                console.log('connection-status ë°ì´í„°:', data);
                
                if (data.connected) {
                    console.log('ì—°ê²° ì„±ê³µìœ¼ë¡œ íŒë‹¨');
                    updateConnectionStatus(type, true);
                    alert(`${type.toUpperCase()} ì—°ê²° ì„±ê³µ!`);
                } else {
                    console.log('ì—°ê²° ì‹¤íŒ¨ë¡œ íŒë‹¨');
                    updateConnectionStatus(type, false);
                    alert(`${type.toUpperCase()} ì—°ê²° ì‹¤íŒ¨ - ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
                }
            } catch (error) {
                console.error('ì—°ê²° ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
                updateConnectionStatus(type, false);
                alert('ì—°ê²° ìƒíƒœ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // ëª¨ë“  ì—°ê²° í•´ì œ
        async function disconnectAll() {
            try {
                await fetch('/disconnect?deviceType=app', { method: 'POST' });
                await fetch('/disconnect?deviceType=adcu', { method: 'POST' });
                updateConnectionStatus('app', false);
                updateConnectionStatus('adcu', false);
                alert('ëª¨ë“  ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error('ì—°ê²° í•´ì œ ì‹¤íŒ¨:', error);
                alert('ì—°ê²° í•´ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // í”„ë¡œí† ì½œ ëª…ë ¹ì–´ ì „ì†¡
        async function sendProtocol(type, commandName) {
            console.log('=== sendProtocol í˜¸ì¶œ ===');
            console.log('type:', type);
            console.log('commandName:', commandName);
            
            // ì—°ê²° ìƒíƒœ í™•ì¸
            try {
                const statusResponse = await fetch(`/connection-status?deviceType=${type}`);
                const statusData = await statusResponse.json();
                
                if (!statusData.connected) {
                    alert(`${type.toUpperCase()} ì—°ê²°ì´ ë˜ì–´ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”.`);
                    return;
                }
            } catch (error) {
                console.error('ì—°ê²° ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
                alert('ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                const response = await fetch('/send-protocol', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `deviceType=${type}&commandName=${encodeURIComponent(commandName)}`
                });
                
                console.log('ì‘ë‹µ ìƒíƒœ:', response.status);
                const result = await response.text();
                console.log('ì‘ë‹µ ë‚´ìš©:', result);
                
                if (result === 'OK') {
                    alert(`${commandName} ëª…ë ¹ì–´ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                } else {
                    alert(`ëª…ë ¹ì–´ ì „ì†¡ ì‹¤íŒ¨: ${result}`);
                }
            } catch (error) {
                console.error('ëª…ë ¹ì–´ ì „ì†¡ ì‹¤íŒ¨:', error);
                alert('ëª…ë ¹ì–´ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateConnectionStatus(type, connected) {
            const statusElement = document.getElementById(`${type}Status`);
            if (connected) {
                statusElement.textContent = 'ì—°ê²°ë¨';
                statusElement.className = 'connection-status status-connected';
            } else {
                statusElement.textContent = 'ì—°ê²° í•´ì œë¨';
                statusElement.className = 'connection-status status-disconnected';
            }
        }
        
        // ìƒíƒœ ì •ë³´ ê°±ì‹ 
        async function refreshStatus() {
            try {
                // APP ì—°ê²° ìƒíƒœ
                const appStatusResponse = await fetch('/connection-status?deviceType=app');
                const appStatusData = await appStatusResponse.json();
                updateConnectionStatus('app', appStatusData.connected);
                
                // APP ìƒíƒœ ê°±ì‹ 
                const appResponse = await fetch('/latest?deviceType=app');
                const appData = await appResponse.json();
                document.getElementById('appRequest').textContent = appData.request || 'ëŒ€ê¸° ì¤‘...';
                document.getElementById('appResponse').textContent = appData.response || 'ëŒ€ê¸° ì¤‘...';
                
                // ADCU ì—°ê²° ìƒíƒœ
                const adcuStatusResponse = await fetch('/connection-status?deviceType=adcu');
                const adcuStatusData = await adcuStatusResponse.json();
                updateConnectionStatus('adcu', adcuStatusData.connected);
                
                // ADCU ìƒíƒœ ê°±ì‹ 
                const adcuResponse = await fetch('/latest?deviceType=adcu');
                const adcuData = await adcuResponse.json();
                document.getElementById('adcuRequest').textContent = adcuData.request || 'ëŒ€ê¸° ì¤‘...';
                document.getElementById('adcuResponse').textContent = adcuData.response || 'ëŒ€ê¸° ì¤‘...';
            } catch (error) {
                console.error('ìƒíƒœ ê°±ì‹  ì‹¤íŒ¨:', error);
            }
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = function() {
            console.log('í˜ì´ì§€ ë¡œë“œë¨, í”„ë¡œí† ì½œ ë¡œë”© ì‹œì‘...');
            loadProtocols();
            // 1ì´ˆë§ˆë‹¤ ìƒíƒœ ê°±ì‹ 
            setInterval(refreshStatus, 1000);
        };
    </script>
</body>
</html>
